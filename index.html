<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Bingo do Sistema Reprodutor</title>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no'>
    <link rel='stylesheet' type='text/css' media='screen' href='main.css'>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
    <!-- Google API client -->
    <script src="https://apis.google.com/js/api.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        .footer-vercel {
            width: 100%;
            text-align: center;
            font-size: 0.95em;
            color: #888;
            margin-top: 40px;
            margin-bottom: 10px;
            opacity: 0.85;
        }
        .footer-vercel .dados-link {
            display: inline-block;
            font-size: 0.95em;
            color: #1976d2;
            background: none;
            border: none;
            text-decoration: underline;
            cursor: pointer; /* Troque para pointer */
            margin-bottom: 4px;
            margin-right: 8px;
            opacity: 0.85;
            transition: color 0.2s;
        }
        .footer-vercel .dados-link:hover {
            color: #0d47a1;
            opacity: 1;
        }
        .footer-vercel .creditos {
            display: block;
            font-size: 0.92em;
            color: #888;
            margin-top: 2px;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <div id="container">
        <div class="header">
            <h1 id="roleta-title">Carregando...</h1>
            <p class="subtitle">Marque as características corretas na sua cartela!</p>
        </div>
        
        <div class="instructions">
            <ul>
                <li>Clique em "Girar" para sortear uma nova dica</li>
                <li>Leia atentamente a característica sorteada</li>
                <li>Se você tiver o termo correspondente na sua cartela, marque-o</li>
                <li>Quando completar uma linha, coluna ou diagonal, grite "BINGO!"</li>
            </ul>
        </div>

        <div id="roleta">
            <div id="interno-roleta">
                <!-- Sections will be generated by JavaScript -->
            </div>
            <button id="spin" class="spin-button">
                <div id="iterno-spin" class="spin-button-inner"></div>
            </button>
        </div>
        <button id="fullscreenButton" class="fullscreen-button">Tela Cheia</button>
    </div>
      
    <!-- Modal -->
    <div id="resultModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Característica Sorteada</h2>
            <p id="modalResult"></p>
        </div>
    </div>

    <!-- Footer para Vercel: link para dados e créditos -->
    <footer class="footer-vercel">
        <a class="dados-link"
           href="https://docs.google.com/spreadsheets/d/1Nhs68C4XDd7dIpLg0L9IdTBcgeuJ2GixOSWfXbJN5oQ/edit?pli=1&gid=0#gid=0"
           target="_blank"
           rel="noopener noreferrer"
           style="cursor:pointer;text-decoration:underline;">
            Link para dados da planilha
        </a>
        <span class="creditos">
            Site desenvolvido por Rangel Gomes em parceria com o PIBID
        </span>
    </footer>

    <script src='main.js'></script>
    <script>
    // Busca dados das abas da planilha via backend FastAPI
    async function fetchTab(tab) {
        // Detecta ambiente local ou produção
        let baseUrl = '';
        if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
            baseUrl = "http://localhost:8000";
        }
        // Para Vercel ou produção, baseUrl será vazio (rota relativa)
        const url = `${baseUrl}/api/v1/sheets/${tab}`;
        try {
            const res = await fetch(url);
            if (!res.ok) {
                console.error(`Erro HTTP ao buscar ${url}:`, res.status, res.statusText);
                if (res.status === 404) {
                    alert("Erro: rota /api/v1/sheets/" + tab + " não encontrada no backend. Certifique-se que o backend FastAPI está rodando e a rota existe.");
                }
                return [];
            }
            const data = await res.json();
            return data.values || [];
        } catch (e) {
            console.error(`Erro ao buscar dados da aba ${tab}:`, e);
            return [];
        }
    }

    async function setupRoletaFromParametros() {
        // Busca parâmetros da roleta
        const parametros = await fetchTab('parameto_roleta');
        if (!parametros || parametros.length < 2) {
            console.error("Parâmetros da roleta inválidos:", parametros);
            document.getElementById('roleta-title').textContent = "Erro ao carregar título";
            return;
        }
        // Extrai os nomes das colunas e os valores
        const [header, values] = parametros;
        const idxNome = header.indexOf("nome_roleta");
        const idxQtd = header.indexOf("quantidades_campos");
        const idxAba = header.indexOf("nome_planilha_lida");
        if (idxNome === -1 || idxQtd === -1 || idxAba === -1) {
            console.error("Colunas obrigatórias não encontradas nos parâmetros:", header);
            document.getElementById('roleta-title').textContent = "Erro ao carregar título";
            return;
        }
        const nomeRoleta = values[idxNome];
        const quantidadesCampos = parseInt(values[idxQtd]);
        const nomeAbaLida = values[idxAba];

        // Atualiza o título da roleta dinamicamente (sem número)
        document.getElementById('roleta-title').textContent = nomeRoleta;

        // Busca os dados da aba definida em nome_planilha_lida
        const dadosRoleta = await fetchTab(nomeAbaLida);

        // Limita as opções conforme quantidadesCampos (parâmetro)
        let opcoes = dadosRoleta.slice(1); // pula header
        if (opcoes.length > quantidadesCampos) {
            opcoes = opcoes.slice(0, quantidadesCampos);
        }

        // Monta a roleta visualmente usando apenas 'opcoes' vindos da API
        if (window.montarRoletaComOpcoes) {
            window.montarRoletaComOpcoes(opcoes);
        }

        // Debug
        console.log("Opções para a roleta (limitadas):", opcoes);
    }

    window.addEventListener('DOMContentLoaded', () => {
        setupRoletaFromParametros();
    });
    </script>
</body>
</html>